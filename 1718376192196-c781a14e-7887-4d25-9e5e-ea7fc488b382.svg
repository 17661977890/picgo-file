<svg xmlns="http://www.w3.org/2000/svg" xmlns:xlink="http://www.w3.org/1999/xlink" version="1.1" width="1674px" height="1123px" viewBox="-0.5 -0.5 1674 1123"><defs/><g><rect x="19" y="366" width="780" height="200" fill="#ffffff" stroke="#000000" pointer-events="all"/><g transform="translate(-0.5 -0.5)"><foreignObject style="overflow: visible; text-align: left;" pointer-events="none" width="100%" height="100%"><div xmlns="http://www.w3.org/1999/xhtml" style="display: flex; align-items: unsafe center; justify-content: unsafe flex-start; width: 778px; height: 1px; padding-top: 466px; margin-left: 21px;"><div style="box-sizing: border-box; font-size: 0; text-align: left; "><div style="display: inline-block; font-size: 12px; font-family: Helvetica; color: #000000; line-height: 1.2; pointer-events: all; white-space: normal; word-wrap: normal; "><div style="font-size: 15px;"><pre><code><b>insert into test.ex_user values\<br /><font color="#ff0000">(10000,'2017-10-01','北京',20,0,'2017-10-01 06:00:00','2017-10-01 06:00:00',20,10,10),\<br />(10000,'2017-10-01','北京',20,0,'2017-10-01 07:00:00','2017-10-01 07:00:00',15,2,2),\</font><br />(10001,'2017-10-01','北京',30,1,'2017-10-01 17:05:45','2017-10-01 07:00:00',2,22,22),\<br />(10002,'2017-10-02','上海',20,1,'2017-10-02 12:59:12',null,200,5,5),\<br />(10003,'2017-10-02','广州',32,0,'2017-10-02 11:20:00','2017-10-02 11:20:00',30,11,11),\<br />(10004,'2017-10-01','深圳',35,0,'2017-10-01 10:00:15','2017-10-01 10:00:15',100,3,3),\<br />(10004,'2017-10-03','深圳',35,0,'2017-10-03 10:20:22','2017-10-03 10:20:22',11,6,6);</b></code></pre></div><font style="font-size: 15px;"></font></div></div></div></foreignObject></g><rect x="16" y="636" width="783" height="150" fill="#ffffff" stroke="#000000" pointer-events="all"/><g transform="translate(-0.5 -0.5)"><foreignObject style="overflow: visible; text-align: left;" pointer-events="none" width="100%" height="100%"><div xmlns="http://www.w3.org/1999/xhtml" style="display: flex; align-items: unsafe center; justify-content: unsafe flex-start; width: 781px; height: 1px; padding-top: 711px; margin-left: 18px;"><div style="box-sizing: border-box; font-size: 0; text-align: left; "><div style="display: inline-block; font-size: 12px; font-family: Helvetica; color: #000000; line-height: 1.2; pointer-events: all; white-space: normal; word-wrap: normal; "><div style="font-size: 15px;"><pre><b style="">写入到一个文件中(只针对一个tablet)</b></pre><pre><code><b><font color="#ff0000">(10000,'2017-10-01','北京',20,0,'2017-10-01 07:00:00','2017-10-01 07:00:00',35,10,2),</font><br />(10001,'2017-10-01','北京',30,1,'2017-10-01 17:05:45','2017-10-01 07:00:00',2,22,22),<br />(10002,'2017-10-02','上海',20,1,'2017-10-02 12:59:12',null,200,5,5),<br />(10003,'2017-10-02','广州',32,0,'2017-10-02 11:20:00','2017-10-02 11:20:00',30,11,11),<br />(10004,'2017-10-01','深圳',35,0,'2017-10-01 10:00:15','2017-10-01 10:00:15',100,3,3),<br />(10004,'2017-10-03','深圳',35,0,'2017-10-03 10:20:22','2017-10-03 10:20:22',11,6,6);</b></code></pre></div></div></div></div></foreignObject></g><rect x="874" y="636" width="783" height="150" fill="#ffffff" stroke="#000000" pointer-events="all"/><g transform="translate(-0.5 -0.5)"><foreignObject style="overflow: visible; text-align: left;" pointer-events="none" width="100%" height="100%"><div xmlns="http://www.w3.org/1999/xhtml" style="display: flex; align-items: unsafe center; justify-content: unsafe flex-start; width: 781px; height: 1px; padding-top: 711px; margin-left: 876px;"><div style="box-sizing: border-box; font-size: 0; text-align: left; "><div style="display: inline-block; font-size: 12px; font-family: Helvetica; color: #000000; line-height: 1.2; pointer-events: all; white-space: normal; word-wrap: normal; "><div style="font-size: 15px;"><pre><b>原来的数据也存放再一个文件中(针对一个tablet)</b></pre><pre><code><b>(10000,'2017-10-01','北京',20,0,'2017-10-01 06:00:00','2017-10-01 06:00:00',100,5,12)<br />(10001,'2017-10-01','上海',20,1,'2017-10-01 17:05:45','2017-10-01 07:00:00',2,22,22)<br />(10002,'2017-10-02','上海',20,1,'2017-10-02 12:59:12',</b><b style="background-color: initial;">'2017-10-01 07:00:00'</b><b style="background-color: initial;">,20,1,50)</b><br /></code></pre></div><font style="font-size: 15px;"></font></div></div></div></foreignObject></g><rect x="903" y="616" width="40" height="20" fill="none" stroke="none" pointer-events="all"/><g transform="translate(-0.5 -0.5)"><foreignObject style="overflow: visible; text-align: left;" pointer-events="none" width="100%" height="100%"><div xmlns="http://www.w3.org/1999/xhtml" style="display: flex; align-items: unsafe center; justify-content: unsafe center; width: 1px; height: 1px; padding-top: 626px; margin-left: 923px;"><div style="box-sizing: border-box; font-size: 0; text-align: center; "><div style="display: inline-block; font-size: 12px; font-family: Helvetica; color: #000000; line-height: 1.2; pointer-events: all; white-space: nowrap; "><b>原来表中的数据：</b></div></div></div></foreignObject></g><rect x="29" y="16" width="870" height="260" fill="none" stroke="none" pointer-events="all"/><g transform="translate(-0.5 -0.5)"><foreignObject style="overflow: visible; text-align: left;" pointer-events="none" width="100%" height="100%"><div xmlns="http://www.w3.org/1999/xhtml" style="display: flex; align-items: unsafe center; justify-content: unsafe flex-start; width: 868px; height: 1px; padding-top: 146px; margin-left: 31px;"><div style="box-sizing: border-box; font-size: 0; text-align: left; "><div style="display: inline-block; font-size: 12px; font-family: Helvetica; color: #000000; line-height: 1.2; pointer-events: all; white-space: normal; word-wrap: normal; "><div style="font-size: 14px;"><pre style=""><code style=""><font style="font-size: 14px;"><b style="">CREATE TABLE IF NOT EXISTS test.ex_user<br />(<br /> <font color="#ff0000">`user_id` LARGEINT NOT NULL COMMENT "用户 id",<br /> `date` DATE NOT NULL COMMENT "数据灌入日期时间",<br /> `city` VARCHAR(20) COMMENT "用户所在城市",<br /> `age` SMALLINT COMMENT "用户年龄",<br /> `sex` TINYINT COMMENT "用户性别",</font><br /><font color="#ff00ff"> `last_visit_date` DATETIME REPLACE DEFAULT "1970-01-01 00:00:00" COMMENT "用户最后一次访问时间",<br /> `last_visit_date_not_null` DATETIME REPLACE_IF_NOT_NULL DEFAULT "1970-01-01 00:00:00" COMMENT "用户最后一次访问时间",<br /> `cost` BIGINT SUM DEFAULT "0" COMMENT "用户总消费",<br /> `max_dwell_time` INT MAX DEFAULT "0" COMMENT "用户最大停留时间",<br /> `min_dwell_time` INT MIN DEFAULT "99999" COMMENT "用户最小停留时</font><br />间" )<br />AGGREGATE KEY(`user_id`, `date`, `city`, `age`, `sex`)<br />DISTRIBUTED BY HASH(`user_id`) BUCKETS 1;</b></font></code></pre></div><font style="font-size: 14px;"><span></span></font></div></div></div></foreignObject></g><rect x="569" y="276" width="360" height="60" fill="#ffff99" stroke="#000000" pointer-events="all"/><g transform="translate(-0.5 -0.5)"><foreignObject style="overflow: visible; text-align: left;" pointer-events="none" width="100%" height="100%"><div xmlns="http://www.w3.org/1999/xhtml" style="display: flex; align-items: unsafe center; justify-content: unsafe flex-start; width: 358px; height: 1px; padding-top: 306px; margin-left: 571px;"><div style="box-sizing: border-box; font-size: 0; text-align: left; "><div style="display: inline-block; font-size: 12px; font-family: Helvetica; color: #000000; line-height: 1.2; pointer-events: all; white-space: normal; word-wrap: normal; "><b>这两条数据的key列是完全相同的，那么在插入数据的时候，doris提前将这两条数据按照上面value的聚合条件进行合并</b></div></div></div></foreignObject></g><path d="M 665.5 400.94 L 742.5 341.06" fill="none" stroke="#000000" stroke-width="2" stroke-miterlimit="10" pointer-events="stroke"/><path d="M 660.76 404.63 L 664.62 396.56 L 665.5 400.94 L 669.53 402.87 Z" fill="#000000" stroke="#000000" stroke-width="2" stroke-miterlimit="10" pointer-events="all"/><path d="M 747.24 337.37 L 743.38 345.44 L 742.5 341.06 L 738.46 339.13 Z" fill="#000000" stroke="#000000" stroke-width="2" stroke-miterlimit="10" pointer-events="all"/><rect x="59" y="336" width="40" height="20" fill="none" stroke="none" pointer-events="all"/><g transform="translate(-0.5 -0.5)"><foreignObject style="overflow: visible; text-align: left;" pointer-events="none" width="100%" height="100%"><div xmlns="http://www.w3.org/1999/xhtml" style="display: flex; align-items: unsafe center; justify-content: unsafe center; width: 1px; height: 1px; padding-top: 346px; margin-left: 79px;"><div style="box-sizing: border-box; font-size: 0; text-align: center; "><div style="display: inline-block; font-size: 12px; font-family: Helvetica; color: #000000; line-height: 1.2; pointer-events: all; white-space: nowrap; "><b>这是插入数据的命令：</b></div></div></div></foreignObject></g><rect x="169" y="616" width="40" height="20" fill="none" stroke="none" pointer-events="all"/><g transform="translate(-0.5 -0.5)"><foreignObject style="overflow: visible; text-align: left;" pointer-events="none" width="100%" height="100%"><div xmlns="http://www.w3.org/1999/xhtml" style="display: flex; align-items: unsafe center; justify-content: unsafe center; width: 1px; height: 1px; padding-top: 626px; margin-left: 189px;"><div style="box-sizing: border-box; font-size: 0; text-align: center; "><div style="display: inline-block; font-size: 12px; font-family: Helvetica; color: #000000; line-height: 1.2; pointer-events: all; white-space: nowrap; "><b>数据插入到表前面的时候会先按照key相同的数据进行预聚合：</b></div></div></div></foreignObject></g><path d="M 403.5 567 L 414.5 567 L 414.5 615.71 L 425.5 615.71 L 409 635.71 L 392.5 615.71 L 403.5 615.71 Z" fill="#b3ff66" stroke="#b3ff66" stroke-width="2" stroke-linejoin="round" stroke-miterlimit="10" pointer-events="all"/><path d="M 456.18 800.83 L 463.34 792.47 L 586.63 898.16 L 593.79 889.81 L 598.24 915.35 L 572.32 914.86 L 579.48 906.51 Z" fill="#b3ff66" stroke="#b3ff66" stroke-width="2" stroke-linejoin="round" stroke-miterlimit="10" pointer-events="all"/><path d="M 1025.4 791.72 L 1030.86 801.27 L 839.96 910.36 L 845.42 919.91 L 819.87 915.5 L 829.05 891.26 L 834.5 900.81 Z" fill="#b3ff66" stroke="#b3ff66" stroke-width="2" stroke-linejoin="round" stroke-miterlimit="10" pointer-events="all"/><rect x="329" y="926" width="783" height="180" fill="#ffffff" stroke="#000000" pointer-events="all"/><g transform="translate(-0.5 -0.5)"><foreignObject style="overflow: visible; text-align: left;" pointer-events="none" width="100%" height="100%"><div xmlns="http://www.w3.org/1999/xhtml" style="display: flex; align-items: unsafe center; justify-content: unsafe flex-start; width: 781px; height: 1px; padding-top: 1016px; margin-left: 331px;"><div style="box-sizing: border-box; font-size: 0; text-align: left; "><div style="display: inline-block; font-size: 12px; font-family: Helvetica; color: #000000; line-height: 1.2; pointer-events: all; white-space: normal; word-wrap: normal; "><div style=""><pre style=""><span style="font-size: 15px;"><b style=""><font color="#ff0000">(10000,'2017-10-01','北京',20,0,'2017-10-01 07:00:00','2017-10-01 07:00:00',135,10,2),<br /></font>(10001,'2017-10-01','北京',30,1,'2017-10-01 17:05:45','2017-10-01 07:00:00',2,22,22),<br /><font color="#ff0000">(10002,'2017-10-02','上海',20,1,'2017-10-02 12:59:12','2017-10-01 07:00:00',220,5,5),<br /></font>(10003,'2017-10-02','广州',32,0,'2017-10-02 11:20:00','2017-10-02 11:20:00',30,11,11),<br />(10004,'2017-10-01','深圳',35,0,'2017-10-01 10:00:15','2017-10-01 10:00:15',100,3,3),<br />(10004,'2017-10-03','深圳',35,0,'2017-10-03 10:20:22','2017-10-03 10:20:22',11,6,6),<br />(10001,'2017-10-01','上海',20,1,'2017-10-01 17:05:45','2017-10-01 07:00:00',2,22,22)</b></span><span style="font-size: 15px;"><br /></span></pre></div></div></div></div></foreignObject></g><rect x="389" y="906" width="40" height="20" fill="none" stroke="none" pointer-events="all"/><g transform="translate(-0.5 -0.5)"><foreignObject style="overflow: visible; text-align: left;" pointer-events="none" width="100%" height="100%"><div xmlns="http://www.w3.org/1999/xhtml" style="display: flex; align-items: unsafe center; justify-content: unsafe center; width: 1px; height: 1px; padding-top: 916px; margin-left: 409px;"><div style="box-sizing: border-box; font-size: 0; text-align: center; "><div style="display: inline-block; font-size: 12px; font-family: Helvetica; color: #000000; line-height: 1.2; pointer-events: all; white-space: nowrap; "><b>和表中的数据做一个最终的聚合</b></div></div></div></foreignObject></g><rect x="429" y="591" width="40" height="20" fill="none" stroke="none" pointer-events="all"/><g transform="translate(-0.5 -0.5)"><foreignObject style="overflow: visible; text-align: left;" pointer-events="none" width="100%" height="100%"><div xmlns="http://www.w3.org/1999/xhtml" style="display: flex; align-items: unsafe center; justify-content: unsafe center; width: 1px; height: 1px; padding-top: 601px; margin-left: 449px;"><div style="box-sizing: border-box; font-size: 0; text-align: center; "><div style="display: inline-block; font-size: 12px; font-family: Helvetica; color: #000000; line-height: 1.2; pointer-events: all; background-color: #FFFF99; white-space: nowrap; "><b><font color="#ff0000">ETL阶段</font></b></div></div></div></foreignObject></g><rect x="689" y="836" width="40" height="20" fill="none" stroke="none" pointer-events="all"/><g transform="translate(-0.5 -0.5)"><foreignObject style="overflow: visible; text-align: left;" pointer-events="none" width="100%" height="100%"><div xmlns="http://www.w3.org/1999/xhtml" style="display: flex; align-items: unsafe center; justify-content: unsafe center; width: 1px; height: 1px; padding-top: 846px; margin-left: 709px;"><div style="box-sizing: border-box; font-size: 0; text-align: center; "><div style="display: inline-block; font-size: 12px; font-family: Helvetica; color: #000000; line-height: 1.2; pointer-events: all; background-color: #FFFF99; white-space: nowrap; "><div><div style=""><b><font color="#ff0000" style="font-size: 15px;">BE 进行数据 Compaction 的阶段</font></b></div></div></div></div></div></foreignObject></g><rect x="579" y="866" width="260" height="20" fill="none" stroke="none" pointer-events="all"/><g transform="translate(-0.5 -0.5)"><foreignObject style="overflow: visible; text-align: left;" pointer-events="none" width="100%" height="100%"><div xmlns="http://www.w3.org/1999/xhtml" style="display: flex; align-items: unsafe center; justify-content: unsafe center; width: 258px; height: 1px; padding-top: 876px; margin-left: 580px;"><div style="box-sizing: border-box; font-size: 0; text-align: center; "><div style="display: inline-block; font-size: 20px; font-family: Helvetica; color: #000000; line-height: 1.2; pointer-events: all; white-space: normal; word-wrap: normal; "><b>这是一个异步操作</b></div></div></div></foreignObject></g><path d="M 1189 516 L 609.49 634.72" fill="none" stroke="#000000" stroke-miterlimit="10" pointer-events="stroke"/><path d="M 604.35 635.78 L 610.5 630.94 L 609.49 634.72 L 611.91 637.8 Z" fill="#000000" stroke="#000000" stroke-miterlimit="10" pointer-events="all"/><path d="M 1189 516 L 1262.08 630.63" fill="none" stroke="#000000" stroke-miterlimit="10" pointer-events="stroke"/><path d="M 1264.9 635.06 L 1258.18 631.04 L 1262.08 630.63 L 1264.09 627.27 Z" fill="#000000" stroke="#000000" stroke-miterlimit="10" pointer-events="all"/><path d="M 1189 346 L 1207.75 252.24" fill="none" stroke="#000000" stroke-miterlimit="10" pointer-events="stroke"/><path d="M 1208.78 247.1 L 1210.84 254.65 L 1207.75 252.24 L 1203.98 253.27 Z" fill="#000000" stroke="#000000" stroke-miterlimit="10" pointer-events="all"/><ellipse cx="1189" cy="431" rx="110" ry="85" fill="#ffffff" stroke="#000000" pointer-events="all"/><rect x="1099" y="381" width="180" height="100" fill="none" stroke="none" pointer-events="all"/><g transform="translate(-0.5 -0.5)"><foreignObject style="overflow: visible; text-align: left;" pointer-events="none" width="100%" height="100%"><div xmlns="http://www.w3.org/1999/xhtml" style="display: flex; align-items: unsafe center; justify-content: unsafe center; width: 178px; height: 1px; padding-top: 431px; margin-left: 1100px;"><div style="box-sizing: border-box; font-size: 0; text-align: center; "><div style="display: inline-block; font-size: 20px; font-family: Helvetica; color: #000000; line-height: 1.2; pointer-events: all; white-space: normal; word-wrap: normal; ">查询运算过程中，会对相同key的数据聚合后再返回</div></div></div></foreignObject></g></g></svg>